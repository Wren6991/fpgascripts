#!/usr/bin/env python3

"""Convert a .bin file to a 32-bit-wide AHB ROM."""

import argparse
import math
import os.path
import struct
import sys

parser = argparse.ArgumentParser()
parser.add_argument("src", help="Source binary file")
parser.add_argument("dst", nargs="?", help="Destination verilog file (defaults to ahb_rom_NAME.v)")
parser.add_argument("--name", "-n", help="Set name suffix for output module", default="boot")
parser.add_argument("--asize", "-a", help="Address bus size (default 32)", type=int, default=32)
parser.add_argument("--reproducible", help="Don't put build-dependent information in the output, e.g. absolute paths")
args = parser.parse_args()

dst = f"ahb_rom_{args.name}.v"
if args.dst is not None:
	dst = args.dst

rom_bytes = open(args.src, "rb").read()
if len(rom_bytes) == 0:
	sys.exit("Input file is empty. Try again dumbass.")
if len(rom_bytes) % 4 != 0:
	rom_bytes = rom_bytes + bytes(4 - len(rom_bytes) % 4)
rom_words = list(w[0] for w in struct.iter_unpack("<L", rom_bytes))

rom_text = "\n".join(f"\t{args.asize}'h{i * 4:x}: ahbls_hrdata = 32'h{w:08x};"
	for i, w in enumerate(rom_words))

rom_src = f"""// Generated by bin2rom, do not modify directly.
// Source: {args.src if args.reproducible else os.path.abspath(args.src)}

`default_nettype none

module ahb_rom_{args.name} (
	input  wire        clk,
	input  wire        rst_n,
	
	// AHB-Lite Port
	input  wire [{args.asize-1}:0] ahbls_haddr,
	input  wire [1:0]  ahbls_htrans,
	input  wire        ahbls_hwrite,
	input  wire [2:0]  ahbls_hsize,
	input  wire        ahbls_hready,
	output wire        ahbls_hready_resp,
	input  wire [31:0] ahbls_hwdata,
	output reg  [31:0] ahbls_hrdata,
	output wire        ahbls_hresp
);

localparam [{args.asize-1}:0] ADDR_MASK = {args.asize}'h{(2 ** math.ceil(math.log2(len(rom_words))) - 1) * 4:x};

reg [{args.asize-1}:0] addr;

always @ (posedge clk or negedge rst_n) begin
	if (!rst_n) begin
		addr <= {{{args.asize}{{1'b0}}}};
	end else if (ahbls_hready) begin
		addr <= ahbls_haddr & ADDR_MASK;
	end
end

assign ahbls_hready_resp = 1'b1;
assign ahbls_hresp = 1'b0;

always @ (*) case (addr)
{rom_text}
	default: ahbls_hrdata = 32'h00000000;
endcase

endmodule

`ifndef YOSYS
`default_nettype wire
`endif
"""

open(dst, "w").write(rom_src)